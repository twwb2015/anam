<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TOEFL Prep - Reading Section</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <style>
        /* Your existing inline CSS here */
    </style>
</head>
<body>
    <header>
        <h1>TOEFL Prep - Reading Section</h1>
    </header>
    <div class="container">
        <div class="instructions" id="instructions">
            <p>Welcome to the TOEFL Reading Section practice test. Click the "Start" button to begin the test. You will have 35 minutes to complete the section. After you complete the questions, click "Submit" to save your results.</p>
        </div>

        <div id="loading-indicator">
            <p>Loading content... Please wait.</p>
            <div id="progress-bar">
                <div id="progress-bar-fill"></div>
            </div>
        </div>

        <div id="timer">Timer will appear here.</div>
        <div id="progress-bar">
            <div id="progress-bar-fill"></div>
        </div>

        <div id="content-section">
            <div class="passage-content" id="passage-content">Passage content will load here.</div>
            <div id="questions-container">Questions will load here.</div>
            <div id="navigation-buttons">
                <button id="back-button">Back</button>
                <button id="next-button">Next</button>
            </div>
            <div id="submit-section">
                <button id="submit-button" disabled>Submit</button>
            </div>
        </div>

        <button id="start-button">Start</button>
    </div>

    <footer>
        <p>Good luck with your preparation!</p>
    </footer>

    <script src="{{ url_for('static', filename='script.js') }}"></script>
    <script>
        document.addEventListener("DOMContentLoaded", async function() {
            const startButton = document.getElementById('start-button');
            const contentSection = document.getElementById('content-section');
            const passageContent = document.getElementById('passage-content');
            const questionsContainer = document.getElementById('questions-container');
            const timerElement = document.getElementById('timer');
            const progressBarFill = document.querySelectorAll('#progress-bar-fill')[1];
            const backButton = document.getElementById('back-button');
            const nextButton = document.getElementById('next-button');
            const submitButton = document.getElementById('submit-button');
            const instructions = document.getElementById('instructions');
            const loadingIndicator = document.getElementById('loading-indicator');
            const loadingProgressBar = document.querySelectorAll('#progress-bar-fill')[0];

            let timeLeft = 35 * 60;
            let currentQuestionIndex = 0;
            let currentPassageIndex = 0;
            let questions = [];
            let passages = [];
            let userAnswers = [];
            let correctAnswers = [];

            async function preloadPassagesAndQuestions() {
                try {
                    loadingIndicator.style.display = 'block';
                    let progress = 0;
                    const loadingInterval = setInterval(() => {
                        progress += 10;
                        loadingProgressBar.style.width = `${progress}%`;
                        if (progress >= 100) {
                            clearInterval(loadingInterval);
                            loadingIndicator.style.display = 'none';
                        }
                    }, 100);

                    const response1 = await fetch('/get_passage');
                    const passageData1 = await response1.json();
                    passages.push(passageData1.passage);

                    const response2 = await fetch('/get_passage');
                    const passageData2 = await response2.json();
                    passages.push(passageData2.passage);

                    const questionsResponse1 = await fetch('/generate_questions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ passage: passages[0] })
                    });
                    const questionsData1 = await questionsResponse1.json();
                    questions.push(questionsData1.questions);

                    const questionsResponse2 = await fetch('/generate_questions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ passage: passages[1] })
                    });
                    const questionsData2 = await questionsResponse2.json();
                    questions.push(questionsData2.questions);

                } catch (error) {
                    console.error('Error preloading passage or questions:', error);
                }
            }

            await preloadPassagesAndQuestions();

            function updateTimer() {
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                timerElement.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
                const progressPercentage = 100 - (timeLeft / (35 * 60)) * 100;
                progressBarFill.style.width = `${progressPercentage}%`;

                if (timeLeft > 0) {
                    timeLeft--;
                    setTimeout(updateTimer, 1000);
                } else {
                    alert('Time is up!');
                    showResult();
                }
            }

            function loadQuestion() {
                if (questions[currentPassageIndex] && questions[currentPassageIndex][currentQuestionIndex]) {
                    const questionData = questions[currentPassageIndex][currentQuestionIndex];
                    const questionParts = questionData.split('\n');
                    const questionText = questionParts[0].replace('Q:', '');
                    const options = questionParts.slice(1);

                    questionsContainer.innerHTML = `
                        <div class="question">
                            <p>Question ${currentQuestionIndex + 1}: ${questionText}</p>
                            <ul>
                                ${options.map((option, index) => `
                                    <li>
                                        <input type="radio" name="question${currentQuestionIndex}" id="q${currentQuestionIndex}_${index}" value="${option}" />
                                        <label for="q${currentQuestionIndex}_${index}">${option}</label>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    `;

                    currentQuestionIndex++;

                    if (currentPassageIndex === 1 && currentQuestionIndex === 10) {
                        nextButton.disabled = true;
                        submitButton.disabled = false;
                    }
                } else {
                    console.error("Questions array is not structured as expected", questions);
                    alert("Error loading questions. Please try again.");
                }
            }

            function showResult() {
                let correct = 0;
                let wrong = 0;
                let unanswered = 0;

                userAnswers.forEach((answer, index) => {
                    if (!answer) {
                        unanswered++;
                    } else if (answer === correctAnswers[Math.floor(index / 10)][index % 10]) {
                        correct++;
                    } else {
                        wrong++;
                    }
                });

                fetch('/save_result', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ correct, wrong, unanswered })
                })
                .then(response => response.json())
                .then(data => {
                    alert('Your results have been saved successfully.');
                })
                .catch(error => {
                    console.error('Error saving results:', error);
                    alert('There was an error saving your results.');
                });
            }

            startButton.addEventListener('click', () => {
                startButton.style.display = 'none';
                instructions.style.display = 'none';
                contentSection.style.display = 'block';
                navigationButtons.style.display = 'block';
                submitButton.disabled = true;

                passageContent.textContent = passages[currentPassageIndex];
                updateTimer();
                loadQuestion();
            });

            nextButton.addEventListener('click', () => {
                const selectedOption = document.querySelector(`input[name="question${currentQuestionIndex - 1}"]:checked`);
                if (selectedOption) {
                    userAnswers[currentPassageIndex * 10 + currentQuestionIndex - 1] = selectedOption.value;
                } else {
                    alert('Please select an answer before proceeding.');
                    return;
                }
                
                loadQuestion();
            });

            backButton.addEventListener('click', () => {
                if (currentQuestionIndex > 0) {
                    currentQuestionIndex--;
                    loadQuestion();
                }
            });

            submitButton.addEventListener('click', () => {
                if (confirm('Are you sure you want to submit?')) {
                    showResult();
                }
            });
        });
    </script>
</body>
</html>
